// Mapas
const mapa_3x3 = '{"name":"Futsal x3 GLH ; By Bazinga! from HaxMaps","width":648,"height":270,"spawnDistance":350,"bg":{"type":"hockey","width":550,"height":240,"kickOffRadius":80,"cornerRadius":0},"vertexes":[{"x":550,"y":240,"trait":"ballArea"},{"x":550,"y":-240,"trait":"ballArea"},{"x":0,"y":270,"trait":"kickOffBarrier"},{"x":0,"y":80,"trait":"kickOffBarrier","color":"F8F8F8","vis":true,"curve":180},{"x":0,"y":-80,"trait":"kickOffBarrier","color":"F8F8F8","vis":true,"curve":180},{"x":0,"y":-270,"trait":"kickOffBarrier"},{"x":-550,"y":-80,"cMask":["red","blue","ball"],"trait":"goalNet","curve":0,"color":"F8F8F8","pos":[-700,-80]},{"x":-590,"y":-80,"cMask":["red","blue","ball"],"trait":"goalNet","curve":0,"color":"F8F8F8","pos":[-700,-80]},{"x":-590,"y":80,"cMask":["red","blue","ball"],"trait":"goalNet","curve":0,"color":"F8F8F8","pos":[-700,80]},{"x":-550,"y":80,"cMask":["red","blue","ball"],"trait":"goalNet","curve":0,"color":"F8F8F8","pos":[-700,80]},{"x":550,"y":-80,"cMask":["red","blue","ball"],"trait":"goalNet","curve":0,"color":"F8F8F8","pos":[700,-80]},{"x":590,"y":-80,"cMask":["red","blue","ball"],"trait":"goalNet","curve":0,"color":"F8F8F8","pos":[700,-80]},{"x":590,"y":80,"cMask":["red","blue","ball"],"trait":"goalNet","curve":0,"color":"F8F8F8","pos":[700,80]},{"x":550,"y":80,"cMask":["red","blue","ball"],"trait":"goalNet","curve":0,"color":"F8F8F8","pos":[700,80]},{"x":-550,"y":80,"bCoef":1.25,"cMask":["ball"],"trait":"ballArea","color":"F8F8F8","pos":[-700,80]},{"x":-550,"y":240,"bCoef":1.25,"cMask":["ball"],"trait":"ballArea","color":"F8F8F8"},{"x":-550,"y":-80,"bCoef":1.25,"cMask":["ball"],"trait":"ballArea","color":"F8F8F8","pos":[-700,-80]},{"x":-550,"y":-240,"bCoef":1.25,"cMask":["ball"],"trait":"ballArea","color":"F8F8F8"},{"x":-550,"y":240,"bCoef":1,"cMask":["ball"],"trait":"ballArea"},{"x":550,"y":240,"bCoef":1,"cMask":["ball"],"trait":"ballArea"},{"x":550,"y":80,"bCoef":1.25,"cMask":["ball"],"trait":"ballArea","pos":[700,80]},{"x":550,"y":240,"bCoef":1.25,"cMask":["ball"],"trait":"ballArea"},{"x":550,"y":-240,"bCoef":1.25,"cMask":["ball"],"trait":"ballArea","color":"F8F8F8"},{"x":550,"y":-80,"bCoef":1.25,"cMask":["ball"],"trait":"ballArea","color":"F8F8F8","pos":[700,-80]},{"x":550,"y":-240,"bCoef":0,"cMask":["ball"],"trait":"ballArea"},{"x":550,"y":-240,"bCoef":0,"cMask":["ball"],"trait":"ballArea"},{"x":-550,"y":-240,"bCoef":1,"cMask":["ball"],"trait":"ballArea","curve":0},{"x":550,"y":-240,"bCoef":1,"cMask":["ball"],"trait":"ballArea","curve":0},{"x":0,"y":-240,"bCoef":0.1,"cMask":["red","blue"],"cGroup":["redKO","blueKO"],"trait":"kickOffBarrier"},{"x":0,"y":-80,"bCoef":0.1,"cMask":["red","blue"],"cGroup":["redKO","blueKO"],"trait":"kickOffBarrier"},{"x":0,"y":80,"bCoef":0.1,"cMask":["red","blue"],"cGroup":["redKO","blueKO"],"trait":"kickOffBarrier"},{"x":0,"y":240,"bCoef":0.1,"cMask":["red","blue"],"cGroup":["redKO","blueKO"],"trait":"kickOffBarrier"},{"x":0,"y":-80,"bCoef":0.1,"cMask":["red","blue"],"trait":"kickOffBarrier","vis":true,"color":"F8F8F8"},{"x":0,"y":80,"bCoef":0.1,"cMask":["red","blue"],"trait":"kickOffBarrier","vis":true,"color":"F8F8F8"},{"x":0,"y":80,"trait":"kickOffBarrier","color":"F8F8F8","vis":true,"curve":-180},{"x":0,"y":-80,"trait":"kickOffBarrier","color":"F8F8F8","vis":true,"curve":-180},{"x":0,"y":80,"trait":"kickOffBarrier","color":"F8F8F8","vis":true,"curve":0},{"x":0,"y":-80,"trait":"kickOffBarrier","color":"F8F8F8","vis":true,"curve":0},{"x":-557.5,"y":80,"bCoef":0.1,"cMask":["ball"],"trait":"ballArea","curve":0,"vis":false,"pos":[-700,80]},{"x":-557.5,"y":240,"bCoef":2,"cMask":["ball"],"trait":"ballArea","curve":0,"vis":false},{"x":-557.5,"y":-240,"bCoef":2,"cMask":["ball"],"trait":"ballArea","vis":false,"curve":0},{"x":-557.5,"y":-80,"bCoef":0.1,"cMask":["ball"],"trait":"ballArea","vis":false,"curve":0,"pos":[-700,-80]},{"x":557.5,"y":-240,"bCoef":2,"cMask":["ball"],"trait":"ballArea","vis":false,"curve":0},{"x":557.5,"y":-80,"bCoef":0.1,"cMask":["ball"],"trait":"ballArea","vis":false,"curve":0,"pos":[700,-80]},{"x":557.5,"y":80,"bCoef":0.1,"cMask":["ball"],"trait":"ballArea","curve":0,"vis":false,"pos":[700,80]},{"x":557.5,"y":240,"bCoef":2,"cMask":["ball"],"trait":"ballArea","curve":0,"vis":false},{"x":0,"y":-80,"bCoef":0.1,"trait":"line"},{"x":0,"y":80,"bCoef":0.1,"trait":"line"},{"x":-550,"y":-80,"bCoef":0.1,"trait":"line"},{"x":-550,"y":80,"bCoef":0.1,"trait":"line"},{"x":550,"y":-80,"bCoef":0.1,"trait":"line"},{"x":550,"y":80,"bCoef":0.1,"trait":"line"},{"x":-240,"y":224,"bCoef":0.1,"trait":"line"},{"x":-240,"y":256,"bCoef":0.1,"trait":"line"},{"x":-120,"y":224,"bCoef":0.1,"trait":"line"},{"x":-120,"y":256,"bCoef":0.1,"trait":"line"},{"x":240,"y":224,"bCoef":0.1,"trait":"line"},{"x":240,"y":256,"bCoef":0.1,"trait":"line"},{"x":120,"y":224,"bCoef":0.1,"trait":"line"},{"x":120,"y":256,"bCoef":0.1,"trait":"line"},{"x":-381,"y":240,"bCoef":0.1,"trait":"line"},{"x":-381,"y":256,"bCoef":0.1,"trait":"line"},{"x":-550,"y":200,"bCoef":0.1,"trait":"line","color":"F8F8F8","curve":-90},{"x":-390,"y":70,"bCoef":0.1,"trait":"line","color":"F8F8F8","curve":0},{"x":-550,"y":226,"bCoef":0.1,"trait":"line","curve":-90},{"x":-536,"y":240,"bCoef":0.1,"trait":"line","curve":-90},{"x":-550,"y":-200,"bCoef":0.1,"trait":"line","color":"F8F8F8","curve":90},{"x":-390,"y":-70,"bCoef":0.1,"trait":"line","color":"F8F8F8","curve":0},{"x":-550,"y":-226,"bCoef":0.1,"trait":"line","curve":90},{"x":-536,"y":-240,"bCoef":0.1,"trait":"line","curve":90},{"x":-556,"y":123,"bCoef":0.1,"trait":"line"},{"x":-575,"y":123,"bCoef":0.1,"trait":"line"},{"x":556,"y":123,"bCoef":0.1,"trait":"line"},{"x":575,"y":123,"bCoef":0.1,"trait":"line"},{"x":-556,"y":-123,"bCoef":0.1,"trait":"line"},{"x":-575,"y":-123,"bCoef":0.1,"trait":"line"},{"x":556,"y":-123,"bCoef":0.1,"trait":"line"},{"x":575,"y":-123,"bCoef":0.1,"trait":"line"},{"x":-381,"y":-240,"bCoef":0.1,"trait":"line"},{"x":-381,"y":-256,"bCoef":0.1,"trait":"line"},{"x":381,"y":240,"bCoef":0.1,"trait":"line"},{"x":381,"y":256,"bCoef":0.1,"trait":"line"},{"x":381,"y":-240,"bCoef":0.1,"trait":"line"},{"x":381,"y":-256,"bCoef":0.1,"trait":"line"},{"x":550,"y":-226,"bCoef":0.1,"trait":"line","curve":-90},{"x":536,"y":-240,"bCoef":0.1,"trait":"line","curve":-90},{"x":550,"y":226,"bCoef":0.1,"trait":"line","curve":90},{"x":536,"y":240,"bCoef":0.1,"trait":"line","curve":90},{"x":550,"y":200,"bCoef":0.1,"trait":"line","color":"F8F8F8","curve":90},{"x":390,"y":70,"bCoef":0.1,"trait":"line","color":"F8F8F8","curve":90},{"x":550,"y":-200,"bCoef":0.1,"trait":"line","color":"F8F8F8","curve":-90},{"x":390,"y":-70,"bCoef":0.1,"trait":"line","color":"F8F8F8","curve":-90},{"x":390,"y":70,"bCoef":0.1,"trait":"line","color":"F8F8F8","curve":0},{"x":390,"y":-70,"bCoef":0.1,"trait":"line","color":"F8F8F8","curve":0},{"x":-375,"y":1,"bCoef":0.1,"trait":"line","curve":180},{"x":-375,"y":-1,"bCoef":0.1,"trait":"line","curve":180},{"x":-375,"y":3,"bCoef":0.1,"trait":"line","curve":180},{"x":-375,"y":-3,"bCoef":0.1,"trait":"line","curve":180},{"x":-375,"y":-2,"bCoef":0.1,"trait":"line","curve":180},{"x":-375,"y":2,"bCoef":0.1,"trait":"line","curve":180},{"x":-375,"y":-3.5,"bCoef":0.1,"trait":"line","curve":180},{"x":-375,"y":3.5,"bCoef":0.1,"trait":"line","curve":180},{"x":375,"y":1,"bCoef":0.1,"trait":"line","curve":180},{"x":375,"y":-1,"bCoef":0.1,"trait":"line","curve":180},{"x":375,"y":3,"bCoef":0.1,"trait":"line","curve":180},{"x":375,"y":-3,"bCoef":0.1,"trait":"line","curve":180},{"x":375,"y":-2,"bCoef":0.1,"trait":"line","curve":180},{"x":375,"y":2,"bCoef":0.1,"trait":"line","curve":180},{"x":375,"y":-3.5,"bCoef":0.1,"trait":"line","curve":180},{"x":375,"y":3.5,"bCoef":0.1,"trait":"line","curve":180},{"x":-277.5,"y":1,"bCoef":0.1,"trait":"line","curve":180},{"x":-277.5,"y":-1,"bCoef":0.1,"trait":"line","curve":180},{"x":-277.5,"y":3,"bCoef":0.1,"trait":"line","curve":180},{"x":-277.5,"y":-3,"bCoef":0.1,"trait":"line","curve":180},{"x":-277.5,"y":-2,"bCoef":0.1,"trait":"line","curve":180},{"x":-277.5,"y":2,"bCoef":0.1,"trait":"line","curve":180},{"x":-277.5,"y":-3.5,"bCoef":0.1,"trait":"line","curve":180},{"x":-277.5,"y":3.5,"bCoef":0.1,"trait":"line","curve":180},{"x":277.5,"y":1,"bCoef":0.1,"trait":"line","curve":180},{"x":277.5,"y":-1,"bCoef":0.1,"trait":"line","curve":180},{"x":277.5,"y":3,"bCoef":0.1,"trait":"line","curve":180},{"x":277.5,"y":-3,"bCoef":0.1,"trait":"line","curve":180},{"x":277.5,"y":-2,"bCoef":0.1,"trait":"line","curve":180},{"x":277.5,"y":2,"bCoef":0.1,"trait":"line","curve":180},{"x":277.5,"y":-3.5,"bCoef":0.1,"trait":"line","curve":180},{"x":277.5,"y":3.5,"bCoef":0.1,"trait":"line","curve":180}],"segments":[{"v0":6,"v1":7,"curve":0,"color":"F8F8F8","cMask":["red","blue","ball"],"trait":"goalNet","pos":[-700,-80],"y":-80},{"v0":7,"v1":8,"curve":0,"color":"F8F8F8","cMask":["red","blue","ball"],"trait":"goalNet","x":-590},{"v0":8,"v1":9,"curve":0,"color":"F8F8F8","cMask":["red","blue","ball"],"trait":"goalNet","pos":[-700,80],"y":80},{"v0":10,"v1":11,"curve":0,"color":"F8F8F8","cMask":["red","blue","ball"],"trait":"goalNet","pos":[700,-80],"y":-80},{"v0":11,"v1":12,"curve":0,"color":"F8F8F8","cMask":["red","blue","ball"],"trait":"goalNet","x":590},{"v0":12,"v1":13,"curve":0,"color":"F8F8F8","cMask":["red","blue","ball"],"trait":"goalNet","pos":[700,80],"y":80},{"v0":2,"v1":3,"trait":"kickOffBarrier"},{"v0":3,"v1":4,"curve":180,"vis":true,"color":"F8F8F8","cGroup":["blueKO"],"trait":"kickOffBarrier"},{"v0":3,"v1":4,"curve":-180,"vis":true,"color":"F8F8F8","cGroup":["redKO"],"trait":"kickOffBarrier"},{"v0":4,"v1":5,"trait":"kickOffBarrier"},{"v0":14,"v1":15,"vis":true,"color":"F8F8F8","bCoef":1.25,"cMask":["ball"],"trait":"ballArea","x":-550},{"v0":16,"v1":17,"vis":true,"color":"F8F8F8","bCoef":1.25,"cMask":["ball"],"trait":"ballArea","x":-550},{"v0":18,"v1":19,"vis":true,"color":"F8F8F8","bCoef":1,"cMask":["ball"],"trait":"ballArea","y":240},{"v0":20,"v1":21,"vis":true,"color":"F8F8F8","bCoef":1.25,"cMask":["ball"],"trait":"ballArea","x":550},{"v0":22,"v1":23,"vis":true,"color":"F8F8F8","bCoef":1.25,"cMask":["ball"],"trait":"ballArea","x":550},{"v0":24,"v1":25,"vis":true,"color":"F8F8F8","bCoef":0,"cMask":["ball"],"trait":"ballArea","x":550,"y":-240},{"v0":26,"v1":27,"curve":0,"vis":true,"color":"F8F8F8","bCoef":1,"cMask":["ball"],"trait":"ballArea","y":-240},{"v0":28,"v1":29,"vis":true,"color":"F8F8F8","bCoef":0.1,"cMask":["red","blue"],"cGroup":["redKO","blueKO"],"trait":"kickOffBarrier"},{"v0":30,"v1":31,"vis":true,"color":"F8F8F8","bCoef":0.1,"cMask":["red","blue"],"cGroup":["redKO","blueKO"],"trait":"kickOffBarrier"},{"v0":38,"v1":39,"curve":0,"vis":false,"color":"F8F8F8","bCoef":2,"cMask":["ball"],"trait":"ballArea","x":-557.5},{"v0":40,"v1":41,"curve":0,"vis":false,"color":"F8F8F8","bCoef":2,"cMask":["ball"],"trait":"ballArea","x":-557.5},{"v0":42,"v1":43,"curve":0,"vis":false,"color":"F8F8F8","bCoef":2,"cMask":["ball"],"trait":"ballArea","x":557.5},{"v0":44,"v1":45,"curve":0,"vis":false,"color":"F8F8F8","bCoef":2,"cMask":["ball"],"trait":"ballArea","x":557.5},{"v0":46,"v1":47,"curve":0,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":0},{"v0":48,"v1":49,"curve":0,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-550},{"v0":50,"v1":51,"curve":0,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":550},{"v0":52,"v1":53,"curve":0,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-240},{"v0":54,"v1":55,"curve":0,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-120},{"v0":56,"v1":57,"curve":0,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":240},{"v0":58,"v1":59,"curve":0,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":120},{"v0":60,"v1":61,"curve":0,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-381},{"v0":62,"v1":63,"curve":-90,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line"},{"v0":65,"v1":64,"curve":-90,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line"},{"v0":66,"v1":67,"curve":90,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line"},{"v0":63,"v1":67,"curve":0,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line"},{"v0":69,"v1":68,"curve":90,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line"},{"v0":70,"v1":71,"curve":0,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-240,"y":123},{"v0":72,"v1":73,"curve":0,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-240,"y":123},{"v0":74,"v1":75,"curve":0,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-240,"y":-123},{"v0":76,"v1":77,"curve":0,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-240,"y":-123},{"v0":78,"v1":79,"curve":0,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-381},{"v0":80,"v1":81,"curve":0,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":381},{"v0":82,"v1":83,"curve":0,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":381},{"v0":85,"v1":84,"curve":-90,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line"},{"v0":87,"v1":86,"curve":90,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line"},{"v0":88,"v1":89,"curve":90,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line"},{"v0":90,"v1":91,"curve":-90,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line"},{"v0":92,"v1":93,"curve":0,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":390},{"v0":95,"v1":94,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-375},{"v0":94,"v1":95,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-375},{"v0":97,"v1":96,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-375},{"v0":96,"v1":97,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-375},{"v0":99,"v1":98,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-375},{"v0":98,"v1":99,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-375},{"v0":101,"v1":100,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-375},{"v0":100,"v1":101,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-375},{"v0":103,"v1":102,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":375},{"v0":102,"v1":103,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":375},{"v0":105,"v1":104,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":375},{"v0":104,"v1":105,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":375},{"v0":107,"v1":106,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":375},{"v0":106,"v1":107,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":375},{"v0":109,"v1":108,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":375},{"v0":108,"v1":109,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":375},{"v0":111,"v1":110,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-277.5},{"v0":110,"v1":111,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-277.5},{"v0":113,"v1":112,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-277.5},{"v0":112,"v1":113,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-277.5},{"v0":115,"v1":114,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-277.5},{"v0":114,"v1":115,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-277.5},{"v0":117,"v1":116,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-277.5},{"v0":116,"v1":117,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":-277.5},{"v0":119,"v1":118,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":277.5},{"v0":118,"v1":119,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":277.5},{"v0":121,"v1":120,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":277.5},{"v0":120,"v1":121,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":277.5},{"v0":123,"v1":122,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":277.5},{"v0":122,"v1":123,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":277.5},{"v0":125,"v1":124,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":277.5},{"v0":124,"v1":125,"curve":180,"vis":true,"color":"F8F8F8","bCoef":0.1,"trait":"line","x":277.5}],"goals":[{"p0":[-556.3,-80],"p1":[-556.3,80],"team":"red"},{"p0":[556.3,80],"p1":[556.3,-80],"team":"blue"}],"discs":[{"radius":5,"pos":[-550,80],"color":"6666CC","trait":"goalPost","y":80},{"radius":5,"pos":[-550,-80],"color":"6666CC","trait":"goalPost","y":-80,"x":-560},{"radius":5,"pos":[550,80],"color":"6666CC","trait":"goalPost","y":80},{"radius":5,"pos":[550,-80],"color":"6666CC","trait":"goalPost","y":-80},{"radius":3,"invMass":0,"pos":[-550,240],"color":"FFCC00","bCoef":0.1,"trait":"line"},{"radius":3,"invMass":0,"pos":[-550,-240],"color":"FFCC00","bCoef":0.1,"trait":"line"},{"radius":3,"invMass":0,"pos":[550,-240],"color":"FFCC00","bCoef":0.1,"trait":"line"},{"radius":3,"invMass":0,"pos":[550,240],"color":"FFCC00","bCoef":0.1,"trait":"line"}],"planes":[{"normal":[0,1],"dist":-240,"bCoef":1,"trait":"ballArea","vis":false,"curve":0},{"normal":[0,-1],"dist":-240,"bCoef":1,"trait":"ballArea"},{"normal":[0,1],"dist":-270,"bCoef":0.1},{"normal":[0,-1],"dist":-270,"bCoef":0.1},{"normal":[1,0],"dist":-642,"bCoef":0.1},{"normal":[-1,0],"dist":-644,"bCoef":0.1},{"normal":[1,0],"dist":-642,"bCoef":0.1,"trait":"ballArea","vis":false,"curve":0},{"normal":[-1,0],"dist":-643,"bCoef":0.1,"trait":"ballArea","vis":false,"curve":0}],"traits":{"ballArea":{"vis":false,"bCoef":1,"cMask":["ball"]},"goalPost":{"radius":8,"invMass":0,"bCoef":0.5},"goalNet":{"vis":true,"bCoef":0.1,"cMask":["ball"]},"line":{"vis":true,"bCoef":0.1,"cMask":[""]},"kickOffBarrier":{"vis":false,"bCoef":0.1,"cGroup":["redKO","blueKO"],"cMask":["red","blue"]}},"playerPhysics":{"bCoef":0,"acceleration":0.11,"kickingAcceleration":0.083,"kickStrength":5},"ballPhysics":{"radius":6.3,"bCoef":0.4,"invMass":1.5,"damping":0.99,"color":"FFCC00"}}';

// Constantes para uso global
const ROOM_NAME = "🤖 MATRIX FUTSAL NB";
const BOT_NAME = "🤖 Matrix BOT";
const MAX_PLAYERS = 16;
const DEFAULT_MAP = mapa_3x3;
const SCORE_LIMIT_DEFAULT = 1;
const TIME_LIMIT_DEFAULT = 3;
const TEAMS_LOCK_DEFAULT = true;
const PASSWORD_DEFAULT = "m";

const RED_TEAM_COLORS_DEFAULT = [1, 0, 0xF57D14, [0xFFFFFF]];
const BLUE_TEAM_COLORS_DEFAULT = [2, 0, 0x000000, [0xF57D14]];

// Emoji list = https://pt.piliapp.com/emoji/list/

// https://www.haxball.com/headless
// Start Room
const room = HBInit({
    roomName: ROOM_NAME,
    maxPlayers: MAX_PLAYERS,
    noPlayer: true,
    playerName: BOT_NAME,
    public: false,
    // https://www.haxball.com/headlesstoken
    token: "thr1.AAAAAF5S_A8wFeD90G-wEA.Z-QlyDuztec"
});

// Configurações da sala
room.setCustomStadium(mapa_3x3);
room.setScoreLimit(SCORE_LIMIT_DEFAULT);
room.setTimeLimit(TIME_LIMIT_DEFAULT);
room.setTeamsLock(TEAMS_LOCK_DEFAULT);
//room.setPassword(PASSWORD_DEFAULT);

//Team Colors
room.setTeamColors(...RED_TEAM_COLORS_DEFAULT);
room.setTeamColors(...BLUE_TEAM_COLORS_DEFAULT);

// Classes da sala
const StatsController = class StatsController
{
    constructor()
    {
        this.stats = {};
        this.lastPlayerKicked = null;
        this.secondLastPlayerKicked = null;
    }

    newPlayer(player)
    {
        if (this.stats.hasOwnProperty(player.id))
        {
            this.stats[player.id].name = player.name;
            return;
        }

        this.stats[player.id] = {};
        this.stats[player.id].name = player.name;
        this.stats[player.id].wins = 0;
        this.stats[player.id].losses = 0;
        this.stats[player.id].score = 0;
        this.stats[player.id].assists = 0;
        this.stats[player.id].rate = 0;
    }

    updateLastKick(player)
    {
        this.secondLastPlayerKicked = this.lastPlayerKicked;
        this.lastPlayerKicked = player;
    }

    printPlayerStat(id)
    {
        var rate = parseInt(this.stats[id].rate);
        var text = "[" + this.stats[id].name + "]"
                    + " 🏆 Wins: "     + this.stats[id].wins
                    + ", 💩 Losses: "  + this.stats[id].losses
                    + ", 📊 Rate: "    + (isNaN(rate) ? 0 : rate) + "%"
                    + ", ⚽ Goals: "   + this.stats[id].score 
                    + ", 🏃‍♂️ Assists: " + this.stats[id].assists;
        
        room.sendAnnouncement(text, null, 0xFFFF00, null, 1);
    }

    printStatList()
    {
        // Players IDs
        Object.keys(this.stats).map((playerID) => 
        {
            this.printPlayerStat(playerID);
        });
    }

    onTeamVictory(scores)
    {
        var players_playing = room.getPlayerList().filter((player) => player.team != 0 );
        var teamWonId = (scores.red > scores.blue) ? 1 : 2 ;
        
        players_playing.forEach((player) =>
        {
            if (player.team == teamWonId)
                this.stats[player.id].wins += 1;
            else
                this.stats[player.id].losses += 1;

            this.stats[player.id].rate = 100 * this.stats[player.id].wins / this.stats[player.id].wins + this.stats[player.id].losses;

            this.printPlayerStat(player.id);
        });
    }

    // Id do time que fez o gol
    onTeamGoal(teamID)
    {
        var striker = this.lastPlayerKicked;
        var assistant = this.secondLastPlayerKicked;

        // Caso o gol seja contra
        if (teamID !== striker.team) {
            
            if (this.secondLastPlayerKicked != null)
            {
                if (teamID !== this.secondLastPlayerKicked.team)
                    return;
                
                striker = this.secondLastPlayerKicked;
                assistant = null;    
            }
        }
        else
        {
            if (this.secondLastPlayerKicked != null && teamID !== this.secondLastPlayerKicked.team)
            {
                assistant = null;
            }  
        }

        this.stats[striker.id].score += 1;
        
        if (assistant != null && assistant.id != striker.id)
            this.stats[assistant.id].assists += 1;

    }

}

const CommandController = class CommandController
{
    
    constructor(statsController) 
    {
        this.statsController = statsController;

        const ICommandPermission = class ICommandPermission
        {
            // Não usar diretamente
            constructor(hasToBeAdmin, method, services = [])
            {
                this.hasToBeAdmin = hasToBeAdmin;
                this.method = method;
                this.services = services;
            }

            // Criar instâncias de ICommandPermission por aqui
            static Create(hasToBeAdmin, method /**/)
            {
                return new ICommandPermission(hasToBeAdmin, method, Array.prototype.slice.call(arguments, 2));
            }

            Execute(player /**/) // : bool
            {
                if (this.hasToBeAdmin && !player.admin)
                    return false;

                var args = Array.from(arguments).concat(this.services);
                return this.method(...args);
            }
        }

        this.CommandsPermissions = {
            "!CAPF"     :   new ICommandPermission(false, this.toogleAdminCommand),
            "!Score"    :   ICommandPermission.Create(false, this.printStatList, this.statsController),
            "!Map"      :   new ICommandPermission(true, this.setMap),
            "!SetPass"  :   new ICommandPermission(true, this.setPassword),
            "!CleanPass":   new ICommandPermission(true, this.cleanPassword)
        };
    }

    // Retorna se é ou não um comando (true or false)
    trataComando(player, message) {
        
        if (!message.startsWith("!"))
            return false;

        console.log("Player: " + player.name + " - Comando: " + message);
        
        var command = message.split(" ");

        try 
        {
            var commandPermission = this.CommandsPermissions[command.shift()];
            // Comando pode não ter sido encontrado, porém ele ainda é considerado uma tentativa.
            // Logo não será mostrado no chat
            if (commandPermission === null || typeof(commandPermission) === "undefined")
                return true;
            
            commandPermission.Execute(player, ...command);
            return true;

        } catch (error) 
        {
            // Mesmo que haja erro não é pra mostrar que houve tentativa de comando
            console.error(error);
            return true;
        }         
    }

    toogleAdminCommand(player, _) 
    {
        room.setPlayerAdmin(player.id, !player.admin);
    }

    printStatList(_, statsControllerInjection)
    {
        statsControllerInjection.printStatList();
    }

    setPassword(_, message)
    {
        room.setPassword(null);
    }

    cleanPassword()
    {
        room.setPassword(null);
    }

    setMap(_, map)
    {
        switch (map) {
            // case "1x":
            //     room.setCustomStadium(mapa_1x1_2x2);
            //     room.setScoreLimit(3);
            //     room.setTimeLimit(2);
            //     break;
            // case "2x":
            //     room.setCustomStadium(mapa_1x1_2x2);
            //     room.setScoreLimit(3);
            //     room.setTimeLimit(2);
            //     break;
            case "3x":
                room.setCustomStadium(mapa_3x3);
                room.setScoreLimit(3);
                room.setTimeLimit(3);
                break;
            // case "4x":
            //     // room.setCustomStadium(mapa_4x4);
            //     // room.setScoreLimit(3);
            //     // room.setTimeLimit(4);
            //     break;
            // case "5x":
            //     room.setCustomStadium(mapa_5x5);
            //     room.setScoreLimit(3);
            //     room.setTimeLimit(5);
            //     break;
        
            default:
                break;
        }
    }
}

const ChatController = class ChatController
{
    constructor(commandController)
    {
        this.commandController = commandController;

        // this.chatInterval = 3000; //ms

        // this.players = room.getPlayerList().map((player) => {
        //     return {"player": player, "lastChatTime": null};
        // });
    }

    // trataSpamming(player)
    // {
    //     var chatPlayer = this.players.find((chatPlayer) => chatPlayer.player.id === player.id);

    //     if (chatPlayer === null || chatPlayer === undefined)
    //         return false;

    //     if (chatPlayer.lastChatTime === null)
    //     {
    //         chatPlayer.lastChatTime = new Date();
    //         return true;
    //     }

    //     var atual = new Date();
    //     var isSpam = atual.getTime() - chatPlayer.lastChatTime.getTime() <= this.chatInterval;
    //     chatPlayer.lastChatTime = atual;

    //     return isSpam;
    // }

    // adicionaPlayer(player)
    // {
    //     this.players.push({"player": player, "lastChatTime": null});
    // }

    // removePlayer(player)
    // {
    //     this.players = this.players.filter((chatPlayer) => 
    //     {
    //         return (chatPlayer.player.id !== player.id);
    //     });
    // }

    trataChat(player, message)
    {   
        // Tratamento para evitar vazamento do comando no chat
        if (message !== "!CAPF" && message.toLowerCase().includes("CAPF".toLowerCase()))
            return false;

        // Ativar somente quando a perfomece estiver boa o suficiente
        // Se true é spam
        // if (this.trataSpamming(player))
        //     return false;

        // Se for um comando retorna false para que não seja mostrado no chat
        if (this.commandController.trataComando(player, message))
            return false;

        // Abre novas possibilidades de tratamento aqui
        return true;
    }
}



// Constantes da sala
const statsController = new StatsController();
const commandController = new CommandController(statsController);
const chatController = new ChatController(commandController);

// Variáveis da sala
////

// Eventos da sala
room.onPlayerJoin = function (player) {
    
    room.sendAnnouncement("["+BOT_NAME+"] 👋 Bem vindo " + player.name + "!", null, 0xF57D14, "bold", 2);

    //chatController.adicionaPlayer(player);

    statsController.newPlayer(player);
}

room.onPlayerLeave = function (player) {

    //chatController.removePlayer(player);
}

room.onPlayerBallKick = function (player) {
    
    verificaAlmoco();

    statsController.updateLastKick(player);
}

room.onTeamVictory = function (scores)
{
    statsController.onTeamVictory(scores);
}

room.onTeamGoal = function (teamID) {
    
    // Mensagem troll de gol
    mensagemGol();

    statsController.onTeamGoal(teamID);
}

room.onPlayerChat = (player, message) => {
    
    // Outros códigos podem ser feitos aqui ainda

    // Caso retorne false no TrataComando trata-se de n ser um comando personalizado
    return chatController.trataChat(player, message);
}


// Métodos
const MENSAGEM_DEFAULT = "🎊 TOCA A MÚSICAAAAA 🎉";
const LISTA_MENSAGENS_DE_GOL = [MENSAGEM_DEFAULT, "🎊 TÁ COM ALEGRIA NAS PERNA 🎊"];
function mensagemGol()
{    
    var i = Math.floor((Math.random() * LISTA_MENSAGENS_DE_GOL.length));
    var mensagem;
    try 
    {
        mensagem = LISTA_MENSAGENS_DE_GOL[i];
    } catch (error) {
        mensagem = MENSAGEM_DEFAULT;
    }

    room.sendAnnouncement(mensagem, null, 0xFF0000, null, 1);
}


function verificaAlmoco()
{
    var d = new Date();
    var n = d.getHours();
    if (n == 14) {
        n = d.getMinutes();
        if (n >= 00) {
            room.sendAnnouncement("⏰ CIRCULANDO PESSOAL, CIRCULANDO...", null, 0xFF0000, null, 1);
        }
    }
}

// Utils
function getRandomColorInt()
{
    return '0x'+(Math.random()*0xFFFFFF<<0).toString(16);
}

function getRandomColorString()
{
    return '#'+(Math.random()*0xFFFFFF<<0).toString(16);
}